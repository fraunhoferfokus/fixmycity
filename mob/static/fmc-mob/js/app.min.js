
/*******************************************************************************
 * 
 * Copyright (c) 2015 Fraunhofer FOKUS, All rights reserved.
 * 
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3.0 of the License, or (at your option) any later version.
 * 
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library. If not, see <http://www.gnu.org/licenses/>. 
 * 
 * AUTHORS: Louay Bassbouss (louay.bassbouss@fokus.fraunhofer.de)
 *
 ******************************************************************************/


(function(){"undefined"==typeof BingMap&&(BingMap=function(a){this.id=a;this.bingMap=null;this.markers={}},BingMap.prototype.init=function(){var a={credentials:settings.BING_MAP_API_KEY,zoom:14,enableSearchLogo:!1,showMapTypeSelector:!1,mapTypeId:Microsoft.Maps.MapTypeId.road};this.bingMap=new Microsoft.Maps.Map($(this.id).get(0),a)},BingMap.prototype.center=function(a){a=new Microsoft.Maps.Location(a.lat,a.lng);this.bingMap.setView({center:a})},BingMap.prototype.addMarker=function(a){var b=Math.random().toString(36).substring(2),
a=new Microsoft.Maps.Location(a.lat,a.lng),a=new Microsoft.Maps.Pushpin(a);this.bingMap.entities.push(a);this.markers[b]=a;return b},BingMap.prototype.moveMarker=function(a,b){if(this.markers[a]){var c=new Microsoft.Maps.Location(b.lat,b.lng);this.markers[a].setLocation(c);this.bingMap.setView({center:c})}},BingMap.prototype.deleteMarker=function(a){delete this.markers[a]},BingMap.prototype.getMarker=function(){return{lat:latlng.latitude,lng:latlng.longitude}},BingMap.prototype.resize=function(a,
b){this.bingMap.setOptions({height:a,width:b})},BingMap.prototype.on=function(a,b){"click"==a&&"function"==typeof b&&Microsoft.Maps.Events.addHandler(this.bingMap,"click",function(a){var e=new Microsoft.Maps.Point(a.getX(),a.getY()),a=a.target.tryPixelToLocation(e);b({lat:a.latitude,lng:a.longitude})})},BingMap.getStaticMap=function(a,b,c,e){return"http://dev.virtualearth.net/REST/V1/Imagery/Map/Road/"+a.latitude+","+a.longitude+"/"+b+"?mapSize="+c+","+e+"&key="+settings.BING_MAP_API_KEY+"&pp="+a.latitude+
","+a.longitude+";34"})})();(function(){"undefined"==typeof GoogleMap&&(GoogleMap=function(a){this.id=a;this.googleMap=null;this.markers={}},GoogleMap.prototype.init=function(){this.googleMap=new google.maps.Map($(this.id).get(0),{zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP,keyboardShortcuts:!1,overviewMapControl:!1,panControl:!1,rotateControl:!1,scaleControl:!1,streetViewControl:!1})},GoogleMap.prototype.center=function(a){a=new google.maps.LatLng(a.lat,a.lng);this.googleMap.center=a},GoogleMap.prototype.addMarker=function(a){var b=
Math.random().toString(36).substring(2),a=new google.maps.LatLng(a.lat,a.lng),a=new google.maps.Marker({position:a,map:this.googleMap});this.markers[b]=a;return b},GoogleMap.prototype.moveMarker=function(a,b){if(this.markers[a]){var c=new google.maps.LatLng(b.lat,b.lng);this.markers[a].setPosition(c);this.googleMap.panTo(c)}},GoogleMap.prototype.deleteMarker=function(a){delete this.markers[a]},GoogleMap.prototype.getMarker=function(){return{lat:latlng.lat(),lng:latlng.lng()}},GoogleMap.prototype.resize=
function(){google.maps.event.trigger(this.googleMap,"resize")},GoogleMap.prototype.on=function(a,b){"click"==a&&"function"==typeof b&&google.maps.event.addListener(this.googleMap,"click",function(a){b({lat:a.latLng.lat(),lng:a.latLng.lng()})})},GoogleMap.getStaticMap=function(a,b,c,e){a="http://maps.googleapis.com/maps/api/staticmap?sensor=false&maptype=roadmap"+("&markers=color:blue|"+a.latitude+","+a.longitude);return a=a+("&format=jpg&zoom="+b)+("&scale=1&size="+Math.round(c)+"x"+Math.round(e))})})();var BingGeocoder=function(){this.provider="bing"};BingGeocoder.prototype.getAddress=function(a,b){$.getJSON("http://dev.virtualearth.net/REST/v1/Locations/"+a.lat+","+a.lng+"?o=json&key="+settings.BING_MAP_API_KEY+"&jsonp=?",function(a){a=a.resourceSets[0].resources[0].address;b({city:a.locality,country:a.countryRegion,postalCode:a.postalCode,street:a.addressLine})})};var GoogleGeocoder=function(){this.provider="google";this.geocoder=new google.maps.Geocoder};
GoogleGeocoder.prototype.getAddress=function(a,b){var c=new google.maps.LatLng(a.lat,a.lng);this.geocoder.geocode({latLng:c},function(a,c){if(c==google.maps.GeocoderStatus.OK){var f={},g=a[0];g.types.indexOf("street_number">=0)&&$.each(g.address_components,function(a,b){$.each(b.types,function(a,c){switch(c){case "street_number":f.houseNo=b.short_name;break;case "route":f.street=b.short_name;break;case "locality":f.city=b.short_name;break;case "country":f.country=b.short_name;break;case "postal_code":f.postalCode=
b.short_name}})});b(f)}else console.log("=== Reverse geocoding failed due to: "+c),b(null)})};(function(){function a(a,b,c){var g='<li data-role="list-divider">Comments <span class="ui-li-count">';$.ajax({url:App.RESOURCE_REPORTS+a+"/comments/",data:{limit:10,offset:c,order_by:"-creationTime"},cache:!1,dataType:"json"}).done(function(a){g+=a.meta.total_count+"</span></li>";var c=_.template('<li id="comment-<%= id %>" class="comment-status-<%= sid %>"><h3><%- uid %></h3><p><%- message %></p><p class="ui-li-aside"><strong><%= time %></strong><br><%= day %>/<%= month %>/<%= year %></p></li>'),
f=/(\d{4})-(\d{1,2})-(\d{1,2})T(\d{1,2}:\d{1,2}):\d{1,2}.*/;$(a.objects).each(function(a,b){var e=0;b.newStatus&&(e=b.newStatus.id);var d=f.exec(b.creationTime);g+=c({id:b.id,sid:e,uid:b.user.username,message:b.message,time:d[4],day:d[3],month:d[2],year:d[1]});var e="#comment-"+b.id,k=b.user.username,m=b.message;$(document).delegate(e,"vclick",function(){$(this).simpledialog({mode:"bool",prompt:"Comment by "+k,subTitle:m,useModal:!1,transition:null,buttons:{Close:{click:function(){},icon:"close",
theme:"a"}}})})});$.ap(b).html(g).listview("refresh")})}function b(a){$.ap("#avg_rating_detail").html("").raty({readOnly:!0,start:a||0.1,half:!0,noRatedMsg:"No ratings yet!",size:24,starHalf:"star-half-big.png",starOff:"star-off-big.png",starOn:"star-on-big.png"})}function c(a,d,f){$.ap("#my_rating_detail").html("");$.ap("#my_rating_detail").raty({click:function(a){$.post(App.RESOURCE_REPORTS+f+"/ratings/",{value:a}).success(function(){c(a,!0,f);$.ajax({url:App.RESOURCE_REPORTS+f+"/",cache:!1,dataType:"json"}).success(function(a){b(a.averageRating)})})},
start:a,readOnly:d,noRatedMsg:"Not rated yet!",size:24,starHalf:"star-half-big.png",starOff:"star-off-big.png",starOn:"star-on-big.png",width:"100%"})}if("undefined"==typeof settings||!settings)settings={MAP_PROVIDER:"google",GEOCODER_PROVIDER:"google",BING_MAP_API_KEY:" "};$("#reportdetails").live("pagebeforeshow",function(){console.log("=== pagebeforeshow for #reportdetails");var e=App.parseUri("cid")||1;$.getJSON(App.RESOURCE_REPORTS+e+"/",function(d){var f=$.ap("#image_detail"),f=0<d.photos.length?
f.attr("src",d.photos[0].photo):f.attr("src",App.IMAGE_MISSING);App.animations?f.hide().unbind("load").bind("load",function(){$(this).fadeIn(1E3)}):f.show();$.ap("#title_detail").text(d.title||"No title");$.ap("#textarea_detail").val(d.description||"No description");$.ap("#tags_detail").val(d.tags);$.ap("#category_detail").val(d.category.title);$.ap("#status_detail").val(d.status.title);$.ap("#countrycode_detail").val(d.address.country);$.ap("#city_detail").val(d.address.city);$.ap("#street_detail").val(d.address.street);
$.ap("#houseno_detail").val(d.address.houseNo);$.ap("#postalcode_detail").val(d.address.postalCode);b(d.averageRating);d="bing"==settings.MAP_PROVIDER?BingMap.getStaticMap(d.address,14,400,300):GoogleMap.getStaticMap(d.address,17,400,300);$.ap("#map_image_detail").css("background-image","url("+d+")");$.getJSON(App.RESOURCE_REPORTS+e+"/ratings/",{user__username:App.username}).success(function(a){var b=0.1,f=!1;0<parseInt(a.meta.total_count)&&(b=a.objects[0].value,f=!0);c(b,f,e)});$.ap("input").each(function(a,
b){""===$.ap(b).val()&&$.ap(b).parent().hide()});a(e,"#comments_detail",0);App.tmp_cid=e;$.ap("#comment_form_details").validate({submitHandler:function(){$.ap("#comment_submit_detail").button("disable");$.post(App.RESOURCE_REPORTS+App.tmp_cid+"/comments/",$.ap("#comment_form_details").serialize()).always(function(){$.ap("#message_detail").val("");a(App.tmp_cid,"#comments_detail",0);$.ap("#comment_submit_detail").button("enable")})}})})})}).call(this);(function(){function a(){$.mobile.hidePageLoadingMsg();b.moveMarker(e,c)}if("undefined"==typeof settings||!settings)settings={MAP_PROVIDER:"google",GEOCODER_PROVIDER:"google",BING_MAP_API_KEY:" "};var b,c,e,d;$("#reportsnearby").live("pageinit",function(){console.log("=== pageinit for #reportsnearby");b="bing"==settings.MAP_PROVIDER?new BingMap("#map_canvas_nearby"):new GoogleMap("#map_canvas_nearby");c=DEFAULT_LOC;b.init();b.center(DEFAULT_LOC);e=b.addMarker(DEFAULT_LOC);b.on("click",function(a){b.moveMarker(e,
a);c=a});var a=parseInt($("#slider_nearby").val());$("#slider_nearby").change(function(){d=parseInt($("#slider_nearby").val());a!=d&&(a=d)});$("#show_nearby").click(function(){var a={latitude:c.lat,longitude:c.lng,order_by:"-creationTime",radius:d,_heading:"Reports Nearby"};$(this).button("disable");$.mobile.changePage("./list",{data:a});return!1})});$("#reportsnearby").live("pagebeforeshow",function(){console.log("=== pagebeforeshow for #reportsnearby");$("#show_nearby").button("enable");d=parseInt($("#slider_nearby").val())||
10;navigator.geolocation?($.mobile.showPageLoadingMsg(),navigator.geolocation.getCurrentPosition(function(a){c={lat:a.coords.latitude,lng:a.coords.longitude};b.moveMarker(e,c);$.mobile.hidePageLoadingMsg()},a)):a()});$("#reportsnearby").live("pageshow",function(){console.log("=== pageshow for #reportsnearby");var a=$("#map_canvas_nearby").height(),c=$("#map_canvas_nearby").width();b.resize(a,c)});$(window).resize(function(){var a=$("#map_canvas_nearby").height(),c=$("#map_canvas_nearby").width();
b.resize(a,c)})}).call(this);(function(){function a(a,b){var c=parseInt(a.offset)||0,c=c+b;a.offset=0>c?0:c;a.limit=Math.abs(b);return"./list?"+$.param(a)}var b=2,c;$("#reportsview").live("pagebeforeshow",function(){var e;console.log("=== pagebeforeshow for #reportsview");b=Math.floor((window.innerHeight-160)/100);b=2<b?b:2;c=App.parseUri();for(e in c)c.hasOwnProperty(e)&&""===c[e]&&delete c[e];c.offset=c.offset||0;c.limit=b;$.ap("#title").text(c._heading||"Reports List");$.ap("#pageNext").unbind("click").click(function(){$.mobile.changePage(a(c,
b),{transition:"none",allowSamePageTransition:!0})});$.ap("#pagePrev").unbind("click").click(function(){$.mobile.changePage(a(c,-b),{transition:"none",allowSamePageTransition:!0})});var d=$.Deferred();$.ajax({url:App.RESOURCE_REPORTS,cache:!1,data:$.extend({order_by:"-creationTime"},c)}).success(function(a){var b=parseInt(a.meta.limit),c=parseInt(a.meta.offset),e=parseInt(a.meta.total_count),j=!0;c+b>=e&&(j=!1);a=[].concat(a.objects);d.resolve(a,c,j)}).fail(function(){d.resolve(null,null,!1)});d.promise().pipe(function(a,
b,c){var e=$.ap("#pagePrev");0==b?e.button("disable"):e.button("enable");b=$.ap("#pageNext");c?b.button("enable"):b.button("disable");var c=$.ap("#reportsList"),d=_.template('<li><a href="detail?cid=<%= id %>"><img src="<%- photo %>" class="report" /><h3><%- title %></h3><p><%- description %></p><div id="rating-<%= id %>"></div></a></li>'),h="";$.each(a,function(a,b){h+=d({id:b.id,title:b.title||"No title",photo:(b.photos[0]||{}).photo||App.IMAGE_MISSING,description:b.description||"No description"})});
c.html(h);$.each(a,function(a,b){var c=b.averageRating||0;$.ap("#rating-"+b.id).raty({readOnly:!0,start:c,half:!0})});App.animations?c.listview("refresh").fadeIn():c.listview("refresh").show()})})}).call(this);(function(){$("#customsearch").live("pageinit",function(){console.log("=== pageinit for #customsearch");$("#location_select").hide();$("#locationOnOff").live("change",function(){"true"===$("#locationOnOff").val()?App.animations?$("#location_select").slideDown("slow"):$("#location_select").show():(App.animations?$("#location_select").slideUp("slow"):$("#location_select").hide(),$("#latitude").val(""),$("#longitude").val(""))});var a=$("#minRating"),b=$("#maxRating");a.live("change",function(){a.val()>
b.val()&&a.val(b.val()).slider("refresh")});b.live("change",function(){b.val()<a.val()&&b.val(a.val()).slider("refresh")});$.getJSON(App.RESOURCE_CATEGORIES,function(a){var b=['<option value="">Pick a category</option>'];$.each(a.objects,function(a,c){b.push('<option value="'+c.id+'">'+c.title+"</option>")});$("#categoryId").html(b.join("\n"));$("#categoryId").selectmenu("refresh",!0)});$.getJSON(App.RESOURCE_STATUSES,function(a){var b=['<option value="">Pick a status</option>'];$.each(a.objects,
function(a,c){b.push('<option value="'+c.id+'">'+c.title+"</option>")});$("#statusId").html(b.join("\n"));$("#statusId").selectmenu("refresh",!0)});$("#search_form").submit(function(){$("input#submit_search").button("disable")})});$("#customsearch").live("pagebeforeshow",function(){console.log("=== pagebeforeshow for #customsearch");$("input#submit_search").button("enable")})}).call(this);"undefined"===typeof App||null===App?function(){console.log("=== Initializing helper class");App={animations:!1,RESOURCE_REPORTS:"/fmc-api/cm/reports/",RESOURCE_CATEGORIES:"/fmc-api/cm/categories/",RESOURCE_STATUSES:"/fmc-api/cm/statuses/",RESOURCE_CROSSPOST:"/fmc-mob/crosspost",IMAGE_MISSING:"/static/fmc-mob/img/nophoto.png",parseUri:function(a){var c=$.mobile.path.parseUrl(location.href).hash.substring(1),c=$.mobile.path.parseUrl(c).search;1>=c.length&&(c=$.mobile.path.parseUrl(location.href).search);
if(1<c.length){var c=c.substring(1).split("&"),e={};if(""==c)return{};for(var d=0;d<c.length;++d){var f=c[d].split("=");2==f.length&&(e[f[0]]=decodeURIComponent(f[1].replace(/\+/g," ")))}return e[a]||e}return{}},staticMap:function(a,c,e,d){a="http://maps.googleapis.com/maps/api/staticmap?sensor=false&maptype=roadmap"+("&markers=color:blue|"+a.latitude+","+a.longitude);return a=a+("&format=jpg&zoom="+c)+("&scale=1&size="+Math.round(e)+"x"+Math.round(d))}};$.ajaxSetup({dataType:"json",cache:!0});$("div").live("pagehide",
function(a){a=jQuery(a.target);"true"==a.attr("force-flush")&&(console.log("=== Removing page from DOM"),a.remove())});$(document).bind("pagebeforechange",function(a,c){if("string"===typeof c.toPage){var e=$.mobile.path.parseUrl(c.toPage);e.search&&(c.options.dataUrl||(c.options.dataUrl=c.toPage),c.toPage=e.hrefNoSearch)}});var a=jQuery;a.ap=function(b){return a.mobile.activePage.find(b)}}.call(this):console.log("=== Not initializing helper class");(function(){$("#login").live("pageinit",function(){$(this).find("form").submit(function(a){a.preventDefault();$(this).find("input[type=submit]").button("disable");App.username=$.trim($(this).find("input#id_username").val());$.mobile.changePage($(this).attr("action"),{type:"post",transition:"fade",reloadPage:"true",data:$(this).serialize()});return!1})});$("#login").live("pagebeforeshow",function(){console.log("=== pagebeforeshow for #login");$.ap("input[type=submit]").button("enable")});$("#login").live("pageshow",
function(){console.log("=== pageshow for #login");$('div[data-role="page"]').each(function(a,b){"login"!==b.id&&($(b).remove(),console.log("=== Page "+b.id+" removed from DOM!"))})})}).call(this);(function(){$("div.menubutton").live("vmousedown",function(){var a=this;$(a).addClass("menubutton-pressed");setTimeout(function(){$(a).removeClass("menubutton-pressed")},500)});$("div.menubutton").live("vmouseup",function(){$(this).removeClass("menubutton-pressed")})}).call(this);var MAP_CANVAS="#map_canvas_new",CATEGORY_PICKER="#category_picker_new",MAIN_FORM="#newreport_form",PHOTO_FORM="#photo_upload_form",IMG_PREVIEW_DIV="#img_preview_div",FILE_INPUT="#form_file_new",PG_FILE_INPUT="#pgPath_new",GET_LOCATION_BTN="#get_location_new",SUBMIT_BTN="#submit_new",DEFAULT_LOC={lat:52.523405,lng:13.41139899999996},geoLoc;
(function(){function a(a,c){var e="./detail?cid="+a,d=App.RESOURCE_CROSSPOST+"?cid="+a;!0===c?$.post(d).always(function(){$.mobile.changePage(e)}):$.mobile.changePage(e)}if("undefined"==typeof settings||!settings)settings={MAP_PROVIDER:"google",GEOCODER_PROVIDER:"google",BING_MAP_API_KEY:" "};console.log("=== Selected Map Provider: "+settings.MAP_PROVIDER+" ;  Selected Geocoding Provider: "+settings.GEOCODER_PROVIDER);map="bing"==settings.MAP_PROVIDER?new BingMap(MAP_CANVAS):new GoogleMap(MAP_CANVAS);
geoCoder="bing"==settings.GEOCODER_PROVIDER?new BingGeocoder:new GoogleGeocoder;$("#newreport").live("pageinit",function(){console.log("=== pageinit for #newreport");map.init();map.center(DEFAULT_LOC);marker=map.addMarker(DEFAULT_LOC);map.moveMarker(marker,DEFAULT_LOC);map.on("click",function(a){map.moveMarker(marker,a);geoLoc=a});$(MAIN_FORM).validate({submitHandler:function(){$(SUBMIT_BTN).button("disable");var b=geoLoc,c="true"===$("#crosspostYesNo").val()?!0:!1,e=function(b){var d=b.id,e=$.ap(FILE_INPUT).val()||
"",b=$.ap(PG_FILE_INPUT).val()||"",f=function(a){console.log("Code: "+a.responseCode);console.log("Response: "+a.response);console.log("Sent: "+a.bytesSent);var b="./detail?cid="+d,a=App.RESOURCE_CROSSPOST+"?cid="+d;!0===c?$.post(a).always(function(){$.mobile.changePage(b)}):$.mobile.changePage(b)},h=function(b){alert("ERROR. Photo upload: "+b.code);a(d,c)};if(0<e.length)b=$.ap(PHOTO_FORM),f=$.Deferred(),b.ajaxSubmit({url:App.RESOURCE_REPORTS+d+"/photos/",type:"POST",dataType:"json",resetForm:!0,
iframe:!0,forceSync:!0,success:f.resolve}),f.promise().done(function(){a(d,c)});else if(0<b.length){var e="http://mashweb.fokus.fraunhofer.de"+App.RESOURCE_REPORTS+d+"/photos/",i=new FileUploadOptions,l=new FileTransfer;i.fileKey="photo";i.fileName=b.substr(b.lastIndexOf("/")+1);i.mimeType="image/jpeg";i.chunkedMode=!1;l.upload(b,encodeURI(e),f,h,i)}else a(d,c)},d=function(){$.post(App.RESOURCE_REPORTS,$.ap(MAIN_FORM).serialize(),e,"json")};"undefined"===typeof b&&(b=DEFAULT_LOC);$.ap("#form_latitude").val(b.lat);
$.ap("#form_longitude").val(b.lng);var f=$.Deferred();geoCoder.getAddress(b,function(a){a?($.ap("#form_houseNo").val(a.houseNo||""),$.ap("#form_street").val(a.street||""),$.ap("#form_city").val(a.city||""),$.ap("#form_countryCode").val(a.country||""),$.ap("#postal_code").val(a.postalCode||""),f.resolve()):f.reject();f.always(d)})}});$(GET_LOCATION_BTN).click(function(){navigator.geolocation?($.mobile.showPageLoadingMsg(),navigator.geolocation.getCurrentPosition(function(a){a={lat:a.coords.latitude,
lng:a.coords.longitude};map.moveMarker(marker,a);geoLoc=a;$.mobile.hidePageLoadingMsg()},$.mobile.hidePageLoadingMsg)):console.log("=== Geolocation not available!");return!1});$.getJSON(App.RESOURCE_CATEGORIES,function(a){var c=[];$.each(a.objects,function(a,b){c.push('<option value="'+b.resource_uri+'">'+b.title+"</option>")});$(CATEGORY_PICKER).html(c.join("\n"));$(CATEGORY_PICKER).selectmenu("refresh",!0)})});$("#newreport").live("pagebeforeshow",function(){console.log("=== pagebeforeshow for #newreport");
$.ap("#form_title_new").val("");$.ap("#form_description_new").val("");$.ap(PHOTO_FORM)[0]&&$.ap(PHOTO_FORM)[0].reset();0<$.ap(PG_FILE_INPUT).length&&$.ap(PG_FILE_INPUT).val("");$.ap(IMG_PREVIEW_DIV).hide();$.ap(FILE_INPUT).show();$.ap(SUBMIT_BTN).button("enable")});$("#newreport").live("pageshow",function(){console.log("=== pageshow for #newreport");var a=$(MAP_CANVAS).height(),c=$(MAP_CANVAS).width();map.resize(a,c)});window.onresize=function(){var a=$(MAP_CANVAS).height(),c=$(MAP_CANVAS).width();
map.resize(a,c)}}).call(this);(function(){$("#settings").live("pagebeforeshow",function(){console.log("=== pagebeforeshow for #settings");if("undefined"!==typeof App.username&&null!==App.username){var a;a="You're currently logged in as <strong>"+(App.username+"</strong>.");$("#name_paragraph_settings").html(a).show()}else $("#name_paragraph_settings").hide()})}).call(this);

